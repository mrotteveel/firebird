# Copyright 2009 The RE2 Authors.  All Rights Reserved.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file.

# To build against ICU for full Unicode properties support,
# uncomment the next two lines:
# CCICU=$(shell pkg-config icu-uc --cflags) -DRE2_USE_ICU
# LDICU=$(shell pkg-config icu-uc --libs)

# To build against PCRE for testing or benchmarking,
# uncomment the next two lines:
# CCPCRE=-I/usr/local/include -DUSEPCRE
# LDPCRE=-L/usr/local/lib -lpcre

CXX?=g++
# can override
CXXFLAGS?=-O3 -g
LDFLAGS?=
# required
RE2_CXXFLAGS?=-std=c++11 -pthread -Wall -Wextra -Wno-unused-parameter -Wno-missing-field-initializers -I. $(CCICU) $(CCPCRE)
RE2_LDFLAGS?=-pthread $(LDICU) $(LDPCRE)
AR?=ar
ARFLAGS?=rsc
NM?=nm
NMFLAGS?=-p

OBJ_DIR?=obj

# Variables mandated by GNU, the arbiter of all good taste on the internet.
# http://www.gnu.org/prep/standards/standards.html
prefix=/usr/local
exec_prefix=$(prefix)
includedir=$(prefix)/include
libdir=$(exec_prefix)/lib
INSTALL=install
INSTALL_DATA=$(INSTALL) -m 644

# Work around the weirdness of sed(1) on Darwin. :/
ifeq ($(shell uname),Darwin)
SED_INPLACE=sed -i ''
else ifeq ($(shell uname),SunOS)
SED_INPLACE=sed -i
else
SED_INPLACE=sed -i
endif

# ABI version
# http://tldp.org/HOWTO/Program-Library-HOWTO/shared-libraries.html
SONAME=9

# To rebuild the Tables generated by Perl and Python scripts (requires Internet
# access for Unicode data), uncomment the following line:
# REBUILD_TABLES=1

# The SunOS linker does not support wildcards. :(
ifeq ($(shell uname),Darwin)
SOEXT=dylib
SOEXTVER=$(SONAME).$(SOEXT)
SOEXTVER00=$(SONAME).0.0.$(SOEXT)
MAKE_SHARED_LIBRARY=$(CXX) -dynamiclib -Wl,-compatibility_version,$(SONAME),-current_version,$(SONAME).0.0,-install_name,$(libdir)/libre2.$(SOEXTVER),-exported_symbols_list,libre2.symbols.darwin $(RE2_LDFLAGS) $(LDFLAGS)
else ifeq ($(shell uname),SunOS)
SOEXT=so
SOEXTVER=$(SOEXT).$(SONAME)
SOEXTVER00=$(SOEXT).$(SONAME).0.0
MAKE_SHARED_LIBRARY=$(CXX) -shared -Wl,-soname,libre2.$(SOEXTVER) $(RE2_LDFLAGS) $(LDFLAGS)
else
SOEXT=so
SOEXTVER=$(SOEXT).$(SONAME)
SOEXTVER00=$(SOEXT).$(SONAME).0.0
MAKE_SHARED_LIBRARY=$(CXX) -shared -Wl,-soname,libre2.$(SOEXTVER),--version-script,libre2.symbols $(RE2_LDFLAGS) $(LDFLAGS)
endif

.PHONY: all
all: $(OBJ_DIR)/libre2.a $(OBJ_DIR)/so/libre2.$(SOEXT)

INSTALL_HFILES=\
	re2/filtered_re2.h\
	re2/re2.h\
	re2/set.h\
	re2/stringpiece.h\

HFILES=\
	util/benchmark.h\
	util/flags.h\
	util/logging.h\
	util/malloc_counter.h\
	util/mix.h\
	util/mutex.h\
	util/pcre.h\
	util/strutil.h\
	util/test.h\
	util/utf.h\
	util/util.h\
	re2/bitmap256.h\
	re2/filtered_re2.h\
	re2/pod_array.h\
	re2/prefilter.h\
	re2/prefilter_tree.h\
	re2/prog.h\
	re2/re2.h\
	re2/regexp.h\
	re2/set.h\
	re2/sparse_array.h\
	re2/sparse_set.h\
	re2/stringpiece.h\
	re2/testing/exhaustive_tester.h\
	re2/testing/regexp_generator.h\
	re2/testing/string_generator.h\
	re2/testing/tester.h\
	re2/unicode_casefold.h\
	re2/unicode_groups.h\
	re2/walker-inl.h\

OFILES=\
	$(OBJ_DIR)/util/rune.o\
	$(OBJ_DIR)/util/strutil.o\
	$(OBJ_DIR)/re2/bitstate.o\
	$(OBJ_DIR)/re2/compile.o\
	$(OBJ_DIR)/re2/dfa.o\
	$(OBJ_DIR)/re2/filtered_re2.o\
	$(OBJ_DIR)/re2/mimics_pcre.o\
	$(OBJ_DIR)/re2/nfa.o\
	$(OBJ_DIR)/re2/onepass.o\
	$(OBJ_DIR)/re2/parse.o\
	$(OBJ_DIR)/re2/perl_groups.o\
	$(OBJ_DIR)/re2/prefilter.o\
	$(OBJ_DIR)/re2/prefilter_tree.o\
	$(OBJ_DIR)/re2/prog.o\
	$(OBJ_DIR)/re2/re2.o\
	$(OBJ_DIR)/re2/regexp.o\
	$(OBJ_DIR)/re2/set.o\
	$(OBJ_DIR)/re2/simplify.o\
	$(OBJ_DIR)/re2/stringpiece.o\
	$(OBJ_DIR)/re2/tostring.o\
	$(OBJ_DIR)/re2/unicode_casefold.o\
	$(OBJ_DIR)/re2/unicode_groups.o\

TESTOFILES=\
	$(OBJ_DIR)/util/pcre.o\
	$(OBJ_DIR)/re2/testing/backtrack.o\
	$(OBJ_DIR)/re2/testing/dump.o\
	$(OBJ_DIR)/re2/testing/exhaustive_tester.o\
	$(OBJ_DIR)/re2/testing/null_walker.o\
	$(OBJ_DIR)/re2/testing/regexp_generator.o\
	$(OBJ_DIR)/re2/testing/string_generator.o\
	$(OBJ_DIR)/re2/testing/tester.o\

TESTS=\
	$(OBJ_DIR)/test/charclass_test\
	$(OBJ_DIR)/test/compile_test\
	$(OBJ_DIR)/test/filtered_re2_test\
	$(OBJ_DIR)/test/mimics_pcre_test\
	$(OBJ_DIR)/test/parse_test\
	$(OBJ_DIR)/test/possible_match_test\
	$(OBJ_DIR)/test/re2_test\
	$(OBJ_DIR)/test/re2_arg_test\
	$(OBJ_DIR)/test/regexp_test\
	$(OBJ_DIR)/test/required_prefix_test\
	$(OBJ_DIR)/test/search_test\
	$(OBJ_DIR)/test/set_test\
	$(OBJ_DIR)/test/simplify_test\
	$(OBJ_DIR)/test/string_generator_test\

BIGTESTS=\
	$(OBJ_DIR)/test/dfa_test\
	$(OBJ_DIR)/test/exhaustive1_test\
	$(OBJ_DIR)/test/exhaustive2_test\
	$(OBJ_DIR)/test/exhaustive3_test\
	$(OBJ_DIR)/test/exhaustive_test\
	$(OBJ_DIR)/test/random_test\

SOFILES=$(patsubst $(OBJ_DIR)/%,$(OBJ_DIR)/so/%,$(OFILES))
# We use TESTOFILES for testing the shared lib, only it is built differently.
STESTS=$(patsubst $(OBJ_DIR)/%,$(OBJ_DIR)/so/%,$(TESTS))
SBIGTESTS=$(patsubst $(OBJ_DIR)/%,$(OBJ_DIR)/so/%,$(BIGTESTS))

DOFILES=$(patsubst $(OBJ_DIR)/%,$(OBJ_DIR)/dbg/%,$(OFILES))
DTESTOFILES=$(patsubst $(OBJ_DIR)/%,$(OBJ_DIR)/dbg/%,$(TESTOFILES))
DTESTS=$(patsubst $(OBJ_DIR)/%,$(OBJ_DIR)/dbg/%,$(TESTS))
DBIGTESTS=$(patsubst $(OBJ_DIR)/%,$(OBJ_DIR)/dbg/%,$(BIGTESTS))

.PRECIOUS: $(OBJ_DIR)/%.o
$(OBJ_DIR)/%.o: %.cc $(HFILES)
	@mkdir -p $$(dirname $@)
	$(CXX) -c -o $@ $(CPPFLAGS) $(RE2_CXXFLAGS) $(CXXFLAGS) -DNDEBUG $*.cc

.PRECIOUS: $(OBJ_DIR)/dbg/%.o
$(OBJ_DIR)/dbg/%.o: %.cc $(HFILES)
	@mkdir -p $$(dirname $@)
	$(CXX) -c -o $@ $(CPPFLAGS) $(RE2_CXXFLAGS) $(CXXFLAGS) $*.cc

.PRECIOUS: $(OBJ_DIR)/so/%.o
$(OBJ_DIR)/so/%.o: %.cc $(HFILES)
	@mkdir -p $$(dirname $@)
	$(CXX) -c -o $@ -fPIC $(CPPFLAGS) $(RE2_CXXFLAGS) $(CXXFLAGS) -DNDEBUG $*.cc

.PRECIOUS: $(OBJ_DIR)/libre2.a
$(OBJ_DIR)/libre2.a: $(OFILES)
	@mkdir -p $(OBJ_DIR)
	$(AR) $(ARFLAGS) $(OBJ_DIR)/libre2.a $(OFILES)

.PRECIOUS: $(OBJ_DIR)/dbg/libre2.a
$(OBJ_DIR)/dbg/libre2.a: $(DOFILES)
	@mkdir -p $(OBJ_DIR)/dbg
	$(AR) $(ARFLAGS) $(OBJ_DIR)/dbg/libre2.a $(DOFILES)

.PRECIOUS: $(OBJ_DIR)/so/libre2.$(SOEXT)
$(OBJ_DIR)/so/libre2.$(SOEXT): $(SOFILES) libre2.symbols libre2.symbols.darwin
	@mkdir -p $(OBJ_DIR)/so
	$(MAKE_SHARED_LIBRARY) -o $(OBJ_DIR)/so/libre2.$(SOEXTVER) $(SOFILES)
	ln -sf libre2.$(SOEXTVER) $@

.PRECIOUS: $(OBJ_DIR)/dbg/test/%
$(OBJ_DIR)/dbg/test/%: $(OBJ_DIR)/dbg/libre2.a $(OBJ_DIR)/dbg/re2/testing/%.o $(DTESTOFILES) $(OBJ_DIR)/dbg/util/test.o
	@mkdir -p $(OBJ_DIR)/dbg/test
	$(CXX) -o $@ $(OBJ_DIR)/dbg/re2/testing/$*.o $(DTESTOFILES) $(OBJ_DIR)/dbg/util/test.o $(OBJ_DIR)/dbg/libre2.a $(RE2_LDFLAGS) $(LDFLAGS)

.PRECIOUS: $(OBJ_DIR)/test/%
$(OBJ_DIR)/test/%: $(OBJ_DIR)/libre2.a $(OBJ_DIR)/re2/testing/%.o $(TESTOFILES) $(OBJ_DIR)/util/test.o
	@mkdir -p $(OBJ_DIR)/test
	$(CXX) -o $@ $(OBJ_DIR)/re2/testing/$*.o $(TESTOFILES) $(OBJ_DIR)/util/test.o $(OBJ_DIR)/libre2.a $(RE2_LDFLAGS) $(LDFLAGS)

# Test the shared lib, falling back to the static lib for private symbols
.PRECIOUS: $(OBJ_DIR)/so/test/%
$(OBJ_DIR)/so/test/%: $(OBJ_DIR)/so/libre2.$(SOEXT) $(OBJ_DIR)/libre2.a $(OBJ_DIR)/re2/testing/%.o $(TESTOFILES) $(OBJ_DIR)/util/test.o
	@mkdir -p $(OBJ_DIR)/so/test
	$(CXX) -o $@ $(OBJ_DIR)/re2/testing/$*.o $(TESTOFILES) $(OBJ_DIR)/util/test.o -L$(OBJ_DIR)/so -lre2 $(OBJ_DIR)/libre2.a $(RE2_LDFLAGS) $(LDFLAGS)

# Filter out dump.o because testing::TempDir() isn't available for it.
$(OBJ_DIR)/test/regexp_benchmark: $(OBJ_DIR)/libre2.a $(OBJ_DIR)/re2/testing/regexp_benchmark.o $(TESTOFILES) $(OBJ_DIR)/util/benchmark.o
	@mkdir -p $(OBJ_DIR)/test
	$(CXX) -o $@ $(OBJ_DIR)/re2/testing/regexp_benchmark.o $(filter-out $(OBJ_DIR)/re2/testing/dump.o, $(TESTOFILES)) $(OBJ_DIR)/util/benchmark.o $(OBJ_DIR)/libre2.a $(RE2_LDFLAGS) $(LDFLAGS)

# re2_fuzzer is a target for fuzzers like libFuzzer and AFL. This fake fuzzing
# is simply a way to check that the target builds and then to run it against a
# fixed set of inputs. To perform real fuzzing, refer to the documentation for
# libFuzzer (llvm.org/docs/LibFuzzer.html) and AFL (lcamtuf.coredump.cx/afl/).
$(OBJ_DIR)/test/re2_fuzzer: CXXFLAGS:=-I./re2/fuzzing/compiler-rt/include $(CXXFLAGS)
$(OBJ_DIR)/test/re2_fuzzer: $(OBJ_DIR)/libre2.a $(OBJ_DIR)/re2/fuzzing/re2_fuzzer.o $(OBJ_DIR)/util/fuzz.o
	@mkdir -p $(OBJ_DIR)/test
	$(CXX) -o $@ $(OBJ_DIR)/re2/fuzzing/re2_fuzzer.o $(OBJ_DIR)/util/fuzz.o $(OBJ_DIR)/libre2.a $(RE2_LDFLAGS) $(LDFLAGS)

ifdef REBUILD_TABLES
.PRECIOUS: re2/perl_groups.cc
re2/perl_groups.cc: re2/make_perl_groups.pl
	perl $< > $@

.PRECIOUS: re2/unicode_%.cc
re2/unicode_%.cc: re2/make_unicode_%.py
	python $< > $@
endif

.PHONY: distclean
distclean: clean
	rm -f re2/perl_groups.cc re2/unicode_casefold.cc re2/unicode_groups.cc

.PHONY: clean
clean:
	rm -rf $(OBJ_DIR)
	rm -f re2/*.pyc

.PHONY: testofiles
testofiles: $(TESTOFILES)

.PHONY: test
test: $(DTESTS) $(TESTS) $(STESTS) debug-test static-test shared-test

.PHONY: debug-test
debug-test: $(DTESTS)
	@./runtests $(DTESTS)

.PHONY: static-test
static-test: $(TESTS)
	@./runtests $(TESTS)

.PHONY: shared-test
shared-test: $(STESTS)
	@./runtests -shared-library-path $(OBJ_DIR)/so $(STESTS)

.PHONY: debug-bigtest
debug-bigtest: $(DTESTS) $(DBIGTESTS)
	@./runtests $(DTESTS) $(DBIGTESTS)

.PHONY: static-bigtest
static-bigtest: $(TESTS) $(BIGTESTS)
	@./runtests $(TESTS) $(BIGTESTS)

.PHONY: shared-bigtest
shared-bigtest: $(STESTS) $(SBIGTESTS)
	@./runtests -shared-library-path $(OBJ_DIR)/so $(STESTS) $(SBIGTESTS)

.PHONY: benchmark
benchmark: $(OBJ_DIR)/test/regexp_benchmark

.PHONY: fuzz
fuzz: $(OBJ_DIR)/test/re2_fuzzer

.PHONY: install
install: static-install shared-install

.PHONY: static
static: $(OBJ_DIR)/libre2.a

.PHONY: static-install
static-install: $(OBJ_DIR)/libre2.a common-install
	$(INSTALL) $(OBJ_DIR)/libre2.a $(DESTDIR)$(libdir)/libre2.a

.PHONY: shared
shared: $(OBJ_DIR)/so/libre2.$(SOEXT)

.PHONY: shared-install
shared-install: $(OBJ_DIR)/so/libre2.$(SOEXT) common-install
	$(INSTALL) $(OBJ_DIR)/so/libre2.$(SOEXT) $(DESTDIR)$(libdir)/libre2.$(SOEXTVER00)
	ln -sf libre2.$(SOEXTVER00) $(DESTDIR)$(libdir)/libre2.$(SOEXTVER)
	ln -sf libre2.$(SOEXTVER00) $(DESTDIR)$(libdir)/libre2.$(SOEXT)

.PHONY: common-install
common-install:
	mkdir -p $(DESTDIR)$(includedir)/re2 $(DESTDIR)$(libdir)/pkgconfig
	$(INSTALL_DATA) $(INSTALL_HFILES) $(DESTDIR)$(includedir)/re2
	$(INSTALL_DATA) re2.pc $(DESTDIR)$(libdir)/pkgconfig/re2.pc
	$(SED_INPLACE) -e "s#@includedir@#$(includedir)#" $(DESTDIR)$(libdir)/pkgconfig/re2.pc
	$(SED_INPLACE) -e "s#@libdir@#$(libdir)#" $(DESTDIR)$(libdir)/pkgconfig/re2.pc

.PHONY: testinstall
testinstall: static-testinstall shared-testinstall
	@echo
	@echo Install tests passed.
	@echo

.PHONY: static-testinstall
static-testinstall: CXXFLAGS:=-std=c++11 -pthread -I$(DESTDIR)$(includedir) $(CXXFLAGS)
static-testinstall: LDFLAGS:=-pthread -L$(DESTDIR)$(libdir) -l:libre2.a $(LDICU) $(LDFLAGS)
static-testinstall:
	@mkdir -p $(OBJ_DIR)
	@cp testinstall.cc $(OBJ_DIR)
ifeq ($(shell uname),Darwin)
	@echo Skipping test for libre2.a on Darwin.
else ifeq ($(shell uname),SunOS)
	@echo Skipping test for libre2.a on SunOS.
else
	(cd $(OBJ_DIR) && $(CXX) testinstall.cc -o testinstall $(CXXFLAGS) $(LDFLAGS))
	$(OBJ_DIR)/testinstall
endif

.PHONY: shared-testinstall
shared-testinstall: CXXFLAGS:=-std=c++11 -pthread -I$(DESTDIR)$(includedir) $(CXXFLAGS)
shared-testinstall: LDFLAGS:=-pthread -L$(DESTDIR)$(libdir) -lre2 $(LDICU) $(LDFLAGS)
shared-testinstall:
	@mkdir -p $(OBJ_DIR)
	@cp testinstall.cc $(OBJ_DIR)
	(cd $(OBJ_DIR) && $(CXX) testinstall.cc -o testinstall $(CXXFLAGS) $(LDFLAGS))
ifeq ($(shell uname),Darwin)
	DYLD_LIBRARY_PATH="$(DESTDIR)$(libdir):$(DYLD_LIBRARY_PATH)" $(OBJ_DIR)/testinstall
else
	LD_LIBRARY_PATH="$(DESTDIR)$(libdir):$(LD_LIBRARY_PATH)" $(OBJ_DIR)/testinstall
endif

.PHONY: benchlog
benchlog: $(OBJ_DIR)/test/regexp_benchmark
	(echo '==BENCHMARK==' `hostname` `date`; \
	  (uname -a; $(CXX) --version; git rev-parse --short HEAD; file $(OBJ_DIR)/test/regexp_benchmark) | sed 's/^/# /'; \
	  echo; \
	  ./$(OBJ_DIR)/test/regexp_benchmark 'PCRE|RE2') | tee -a benchlog.$$(hostname | sed 's/\..*//')

.PHONY: log
log:
	$(MAKE) clean
	$(MAKE) CXXFLAGS="$(CXXFLAGS) -DLOGGING=1" \
		$(filter $(OBJ_DIR)/test/exhaustive%_test,$(BIGTESTS))
	echo '#' RE2 exhaustive tests built by make log >re2-exhaustive.txt
	echo '#' $$(date) >>re2-exhaustive.txt
	$(OBJ_DIR)/test/exhaustive_test |grep -v '^PASS$$' >>re2-exhaustive.txt
	$(OBJ_DIR)/test/exhaustive1_test |grep -v '^PASS$$' >>re2-exhaustive.txt
	$(OBJ_DIR)/test/exhaustive2_test |grep -v '^PASS$$' >>re2-exhaustive.txt
	$(OBJ_DIR)/test/exhaustive3_test |grep -v '^PASS$$' >>re2-exhaustive.txt

	$(MAKE) CXXFLAGS="$(CXXFLAGS) -DLOGGING=1" $(OBJ_DIR)/test/search_test
	echo '#' RE2 basic search tests built by make $@ >re2-search.txt
	echo '#' $$(date) >>re2-search.txt
	$(OBJ_DIR)/test/search_test |grep -v '^PASS$$' >>re2-search.txt
